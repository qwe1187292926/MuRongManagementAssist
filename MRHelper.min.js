// ==UserScript==
// @name         出勤助手
// @namespace    https://github.com/qwe1187292926/
// @version      2.3
// @icon         https://www.agemys.com/favicon.ico
// @description  A script enhance MR attendance management
// @homepageURL    https://github.com/qwe1187292926/MuRongManagementAssist
// @supportURL     https://github.com/qwe1187292926/MuRongManagementAssist/issue
// @updateURL    https://cdn.jsdelivr.net/gh/qwe1187292926/MuRongManagementAssist/MRHelper.min.js
// @downloadURL    https://cdn.jsdelivr.net/gh/qwe1187292926/MuRongManagementAssist/MRHelper.min.js
// @author       NOBODY
// @match      https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332005
// @match      https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332015
// @match      https://mis.murongtech.com/mrmis/login.do
// @match      https://mis.murongtech.com/mrmis/
// @match      https://mis.murongtech.com/mrmis/toHome.do
// @match      https://mis.murongtech.com/mrmis/logOut.do
// @require      https://mis.murongtech.com/mrmis/js/bootstrap-datatable/bootstrap-table.js?t=202009080152320
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// ==/UserScript==
const WORK_DAY="0",ON_WORK="01",TRAVEL_DICT={"1":"\u51FA\u5DEE","0":"\u6B63\u5E38"},WORK_DICT={"03":"\u4E8B\u5047","04":"\u75C5\u5047","05":"\u5A5A\u5047","02":"\u8C03\u4F11","00":"\u672A\u51FA\u52E4","12":"\u5C45\u5BB6\u529E\u516C","14":"\u80B2\u513F\u5047","11":"\u8FDC\u7A0B","06":"\u4E27\u5047","07":"\u966A\u4EA7\u5047","08":"\u4EA7\u5047","13":"\u75C5\u4F11","10":"\u4EA7\u68C0\u5047","09":"\u5E74\u5047","01":"\u221A"};let loginUser={oper_no:"",oper_pwd:"",oper_log_mod:"1",rad:""},MRCfg={resetFirstLoadRows:0,defaultLoginUser:{username:"",password:""},savedUsers:[],proId:"",welcomeWords:"\u667A\u80FD\u51FA\u52E4\u811A\u672C\u52A0\u8F7D\u6210\u529F\uFF01"};function initMRCfg(){let saved=GM_getValue("MR_CONFIG","");""==saved?GM_setValue("MR_CONFIG",MRCfg):mergeObject(saved,MRCfg),MRCfg=saved}function saveMRCfg(){GM_setValue("MR_CONFIG",MRCfg)}function setSavedUsers(username,password){console.log(username,password);let object={username:username,password:password};MRCfg.savedUsers.push(object),saveMRCfg()}function delSavedUser(name){MRCfg.savedUsers.splice(getIndexOfUser(name),1),saveMRCfg()}function getIndexOfUser(name){return MRCfg.savedUsers.findIndex(a=>a.username===name)}function clearSavedUsers(){MRCfg.savedUsers=[],saveMRCfg(),notify("\u6570\u636E\u5DF2\u6E05\u9664")}function setWorkStatus(){let data=$("#murong-table");data.bootstrapTable("checkAll");let rows=data.bootstrapTable("getSelections"),length=rows.length;for(let n=1;n<=length;n++){let row=rows[n-1];row.hld_flg==WORK_DAY&&(row.att_typ=ON_WORK)}refreshTable(),notify("\u5DF2\u81EA\u52A8\u52FE\u9009\u5DE5\u4F5C\u65E5\u4E3A\u51FA\u52E4\uFF01")}function setProductInfo(proId,rows,isSave=!0){$HTTP("post","https://mis.murongtech.com/mrmis/attProjectQuery.do","search=&t="+Date.now()+"&limit=10&offset=0&totalRows=8&pro_nm="+proId,function(res){let data=(res=JSON.parse(res.responseText)).rec[0];if("1"==res.rec_num||confirm("\u5F53\u524D\u9879\u76EE\u5305\u542B\u591A\u4E2A\u9879\u76EE\u7F16\u53F7\uFF0C\u662F\u5426\u9009\u7528\u6700\u76F8\u8FD1\u7684\u7ED3\u679C\uFF1A\n\u9879\u76EE\u7F16\u53F7\uFF1A"+data.pro_id+"\n\u9879\u76EE\u540D\u79F0\uFF1A\u300A"+data.pro_nm+"\u300B\n\u9879\u76EE\u8D1F\u8D23\u4EBA\uFF1A"+data.att_man_nm)){console.log(res);let length=rows.length;for(let n=1;n<=length;n++){let row=rows[n-1];for(let key in data)eval("row."+key+"= data['"+key+"']")}refreshTable(),isSave&&(MRCfg.proId=proId,saveMRCfg(),notify(`${proId} 项目编号已记录`)),notify(`已应用${proId}到选中行`)}else console.log("ads",res),notify("\u9879\u76EE\u67E5\u8BE2\u7ED3\u679C\u5305\u542B\u591A\u4E2A\u6216\u65E0\u7ED3\u679C\uFF01")},function(a){console.log(a),notify("\u8BF7\u6C42\u5931\u8D25\uFF0C\u8BE6\u89C1\u63A7\u5236\u53F0\uFF01")})}function $HTTP(method,url,data,onSuccess,onFailed){GM_xmlhttpRequest({method:method,url:url,data:data,headers:{Referer:getLocation(),"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Cookie:document.cookie},onload:onSuccess,onerror:onFailed})}!function(){"use strict";if(initMRCfg(),isLoginPage()){let e=$("#oper_no"),f=$("#oper_pwd1");""!=MRCfg.defaultLoginUser.password&&""!=MRCfg.defaultLoginUser.username&&(notify("\u5DF2\u81EA\u52A8\u586B\u5145\u9ED8\u8BA4\u767B\u5F55\u8D26\u53F7"),f.val(MRCfg.defaultLoginUser.password),e.val(MRCfg.defaultLoginUser.username)),MRCfg.savedUsers.length>1&&""==MRCfg.defaultLoginUser.password&&notify("\u4F60\u53EF\u4EE5\u70B9\u51FB\u6807\u9898\u8BBE\u7F6E\u81EA\u52A8\u586B\u5145\u767B\u5F55\u7528\u6237\u6216\u8005\u8FDB\u884C\u591A\u8D26\u53F7\u7BA1\u7406\uFF01");let b=$($("button[type=submit]")[0]),d=$(`<a>清除已保存的用户</a>`);d.click(clearSavedUsers),$($("a[data-toggle]")[0]).parent().parent().append(d),b.removeAttr("type"),b.text("Save and login"),b.click(d=>{d.preventDefault();let b=$("#oper_no").val(),a=$("#oper_pwd1").val(),c=MRCfg.savedUsers.find(a=>a.username===b);void 0!=c?a!=c.password&&setSavedUsers(b,a):setSavedUsers(b,a),login(b,a)}),$("h3.form-title").click(function(){initTableSavedUsers()});return}welcome();let a=$("#toolbar");0!==a.length&&(a.prepend(btnGenerator("hoyoung_set_status_data"," \u81EA\u9009\u6761\u4EF6\u586B\u5145","yellow-stripe","fa fa-check-square-o","\u5C06\u9009\u4E2D\u884C\u5E94\u7528\u8FD9\u4E2A\u51FA\u52E4\u72B6\u6001")),a.prepend(btnGenerator("hoyoung_set_product_data"," \u667A\u6167\u586B\u5145","green-stripe","fa fa-rocket","\u5C06\u8BE5\u9879\u76EE\u7F16\u53F7\u586B\u5165\u5230\u6240\u6709\u9879\u76EE\uFF0C\u5E76\u81EA\u52A8\u52FE\u9009\u51FA\u52E4\u72B6\u6001")),a.prepend('<input id="search_proid" placeholder="\u8BF7\u8F93\u5165\u9879\u76EE\u7F16\u53F7" style="margin-right: 5px;max-width: 8rem" class="m-wrap span5" type="text" value="'+MRCfg.proId+'"/>'),a.find("#hoyoung_set_product_data").click(function(){let b=$("#murong-table");b.bootstrapTable("checkAll");let c=b.bootstrapTable("getSelections");setProductInfo(a.find("#search_proid").val(),c),setWorkStatus()}),a.find("#hoyoung_set_status_data").click(function(){initConditionApply()}),0!=MRCfg.resetFirstLoadRows&&isChuQingPage()&&($("table#murong-table").bootstrapTable("getOptions").pageSize=MRCfg.resetFirstLoadRows,conditionQuery()));let c=`<li id="multiAccount"><a href="#"><i class="icon-user"></i>多账号管理</a></li>`;$("ul.nav li.user").before(c),c=`<li id="hoyoung_setting"><a href="#"><i class="icon-cogs"></i>脚本设置</a></li>`,$("ul.nav li.user").before(c),$("#multiAccount").click(()=>{initTableSavedUsers()}),$("#hoyoung_setting").click(()=>{initSettingModal()})}();let modalCurView="";function customMyModelView(html,title){if(0==$("#hoyoungModal").length){modalCurView=title;let modelTemplate='<div aria-hidden="false"aria-labelledby="myModalLabel"role="dialog"tabindex="-1"id="hoyoungModal"class="modal fade ui-draggable in"style="display: block;"><div class="modal-dialog"style="width: 600px;"><div class="portlet box blue"><div class="portlet-title"><div class="caption"><i class="icon-reorder"></i><span id="closeM">'+title+'</span></div></div><div class="portlet-body modal-body"id="mmmmodal-body">'+html+"</div></div></div></div>";$("body").append(modelTemplate),$("#hoyoungModal").hide(),$("#hoyoungModal").modal("show"),$("#closeM").click(()=>{hideModal()})}else modalCurView!==title&&(modalCurView=title,$("#closeM").text(title),$("#mmmmodal-body").html(html)),$("#hoyoungModal").modal("show")}function initConditionApply(){let productId="",selectData=`<div>出勤情况：<select name="chk_sts" id="hoyoung_custom_status_data" class="m-wrap span5" style="margin: 0 0px 0 1rem;padding:0;max-width: 5rem">`,keys=Object.keys(WORK_DICT),values=Object.values(WORK_DICT);for(let i=0;i<keys.length;i++)selectData+=`<option value=${keys[i]}>${values[i]}</option>`;selectData+="</select></div>",selectData+=`<div>是否出差：<select name="chk_sts" id="hoyoung_custom_travel_data" class="m-wrap span5" style="margin:0 0px 0 1rem;padding:0;max-width: 5rem">`,keys=Object.keys(TRAVEL_DICT),values=Object.values(TRAVEL_DICT);for(let i=0;i<keys.length;i++)selectData+=`<option value=${keys[i]}>${values[i]}</option>`;selectData+="</select></div>",customMyModelView('<div style="/* display:flex; *//* justify-content: flex-start; *//* align-content: center; *//* flex-wrap: nowrap; *//* flex-direction: row; */"><div class="span3"style="width: 100%;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;"><div><label class="btn green-stripe" style="margin: 0;">\u8D77\u59CB\u65E5\u671F</label><input class="span5 m-wrap" placeholder="\u65E5\u671F\u683C\u5F0F: YYmmdd" id="hoyoung_custom_start_date" value="'+dateFormat("YYmm",new Date)+'01" style="margin: 0 0 0 1rem;width: fit-content;"></div>\u2014<div><label class="btn green-stripe"style="margin: 0;">\u7ED3\u675F\u65E5\u671F</label><input class="span5 m-wrap" placeholder="\u65E5\u671F\u683C\u5F0F: YYmmdd" value="'+dateFormat("YYmmdd",new Date)+'" id="hoyoung_custom_end_date" style="margin: 0 0 0 1rem;width: fit-content;"></div></div><div class="span3"style="width: 100%;padding-top: 1rem;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;">'+selectData+'</div><div class="pull-right"><label for="skipHoliday"style="width: fit-content;margin-top: 2rem;margin-left: auto;"><input type="checkbox"id="skipHoliday"style="margin: 0;">&nbsp;\u5FFD\u7565\u8282\u5047\u65E5</label><label for="applyProduct" style="width: fit-content;margin-left: auto;"><input type="checkbox" id="applyProduct" style="margin: 0;"><span id="apSpan">&nbsp;\u53E6\u8BBE\u9879\u76EE\u7F16\u53F7</span></label><button class="pull-right btn yellow-stripe"style=""id="hoyoung_custom_apply">\u5E94\u7528\u5230\u6240\u9009\u65E5\u671F\u533A\u95F4</button></div><div class="span3"style="width: 100%;padding-top: 1rem;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;color: green;align-items: center;">*\u65E5\u671F\u7684\u586B\u5199\u683C\u5F0F\u4E3AYYmmdd\uFF0C\u5373\u5E74\u6708\u65E5\uFF0C\u9700\u8981\u6EE1\u8DB3\u516B\u4F4D\u957F\u5EA6\uFF08\u4F8B\u59822022\u5E741\u67081\u65E5\u5BF9\u5E94\u7684\u662F20220101\uFF09\uFF0C\u6BCB\u987B\u643A\u5E26\u6A2A\u6760</div></div>',"\u6309\u81EA\u9009\u89C4\u5219\u586B\u5145"),$("#applyProduct").unbind().click(()=>{$("#applyProduct").prop("checked")?""!==(productId=prompt("\u8F93\u5165\u9879\u76EE\u7F16\u53F7"))&&$("#apSpan").text(" \u53E6\u8BBE\u9879\u76EE\u7F16\u53F7("+productId+")"):$("#apSpan").text(" \u53E6\u8BBE\u9879\u76EE\u7F16\u53F7")}),$("#hoyoung_custom_apply").unbind().click(function(){let c=-1,a=$("#murong-table");a.bootstrapTable("uncheckAll");let b=a.bootstrapTable("getOptions").data,d=$("#skipHoliday").prop("checked"),e=$("#hoyoung_custom_start_date").val(),f=$("#hoyoung_custom_end_date").val();$.each(b,function(g,a){let b=parseInt(a.att_dt);if(b>=e&&b<=f){if(d&&a.hld_flg!==WORK_DAY)return!0;-1===c&&(c=g),a.state=!0,a.att_typ=$("#hoyoung_custom_status_data").val(),a.travel_flg=$("#hoyoung_custom_travel_data").val()}}),""!=productId&&(b=a.bootstrapTable("getSelections"),notify("\u8BF7\u7A0D\u540E\uFF0C\u6B63\u5728\u5E94\u7528\u9879\u76EE\u7F16\u53F7\uFF0C\u7981\u6B62\u64CD\u4F5C"),setProductInfo(productId,b,!1)),hideModal(),refreshTable(),console.log($("tbody tr")[c]),$("tbody tr")[c].scrollIntoView()})}function initSettingModal(){customMyModelView('<div style="/* display:flex; *//* justify-content: flex-start; *//* align-content: center; *//* flex-wrap: nowrap; *//* flex-direction: row; */"><div class="span3"style="width: 100%;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;"><label class="btn green-stripe"style="margin: 0;">\u4FEE\u6539\u9ED8\u8BA4\u52A0\u8F7D\u6570\u636E\u7684\u6761\u6570</label><input class="span5 m-wrap"name="hoyoung-setting"id="resetFirstLoadRows"value="'+MRCfg.resetFirstLoadRows+'"style="margin: 0 1rem 0 0;width: fit-content;"></div><div class="span3"style="width: 100%;display: flex;margin-left: 0;margin-top: 1rem;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;"><label class="btn blue-stripe"style="margin: 0;">\u811A\u672C\u542F\u52A8\u63D0\u793A</label><input class="span5 m-wrap"name="hoyoung-setting"id="welcomeWords"value="'+MRCfg.welcomeWords+'"style="margin: 0 1rem 0 0;width: fit-content;"></div><button class="btn pull-right yellow-stripe"style="margin-top: 1rem;"id="hoyoung-save-setting">\u4FDD\u5B58\u8BBE\u7F6E</button><div class="span3"style="width: 100%;padding-top: 1rem;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;color: green;flex-direction: row;align-items: center;"><p style="margin: 0">* \u6570\u636E\u9ED8\u8BA4\u52A0\u8F7D\u6761\u6570\uFF0C\u9ED8\u8BA4\u4E3A10\u6761\uFF0C\u5F53\u8BE5\u503C\u88AB\u8BBE\u7F6E\u4E3A0\u65F6\uFF0C\u4E0D\u518D\u52AB\u6301\u9ED8\u8BA4\u52A0\u8F7D\u6761\u6570\u3002</p><p style="margin: 0">&nbsp;&nbsp;\u5F53\u811A\u672C\u542F\u52A8\u63D0\u793A\u53C2\u6570\u88AB\u8BBE\u7F6E\u4E3A\u7A7A\u65F6\uFF0C\u542F\u52A8\u5B8C\u6BD5\u4E0D\u518D\u53D1\u51FA\u63D0\u9192\u3002</p></div></div>',"\u51FA\u52E4\u811A\u672C\u8BBE\u7F6E"),$("#hoyoung-save-setting").unbind().click(function(){$("input[name=hoyoung-setting]").each((i,obj)=>{let v=$(obj).val();"NaN"===parseFloat(v).toString()&&(v="'"+v+"'"),eval("MRCfg."+$(obj).attr("id")+"="+v),saveMRCfg(),hideModal()}),console.log(MRCfg)})}function hideModal(){$("#hoyoungModal").modal("hide")}function initTableSavedUsers(){customMyModelView('<div style="display: flex;justify-content: space-between;flex-wrap: wrap;"><button class="btn btn-primary"id="hoyoung_set_dfl_login_user"><i class="fa fa-check-square-o"></i>\u9ED8\u8BA4\u767B\u5F55\u7528\u6237</button><button class="btn btn-primary"id="hoyoung_login"><i class="fa fa-check-square-o"></i>Login</button><button class="btn btn-primary"id="hoyoung_del_user"><i class="fa fa-check-square-o"></i>delete</button></div><table class="murong-table table table-hover"id="hoyoung_table"data-toggle="table"data-click-to-select="true"data-show-columns="false"data-select-item-name="myRadioName"></table>',"\u5207\u6362\u767B\u5F55\u7528\u6237"),($table=$("#hoyoung_table")).on("click-row.bs.table",function(b,c,a){$(".success").removeClass("success"),$(a).addClass("success")}),$table.bootstrapTable({columns:[{fileid:"state",checkbox:!0},{title:"\u5E8F\u53F7",field:"index",align:"center",valign:"middle",sortable:"true"},{title:"\u7528\u6237\u540D",field:"username",align:"center",valign:"middle",sortable:"true"}]}),$table.on("click-row.bs.table",function(b,c,a){$(".success").removeClass("success"),$(a).addClass("success")}),$table.bootstrapTable("load",getWarpedSavedUsers()),$("#hoyoung_set_dfl_login_user").unbind().click(function(){let a=$table.bootstrapTable("getSelections");if(a.length>1)notify("\u5751\u7239\u5462\uFF0C\u4F60\u9ED8\u8BA4\u767B\u5F55\u8FD9\u4E48\u591A\u4E2A\u7528\u6237\u5417\uFF1F");else for(let b=0;b<a.length;b++)MRCfg.defaultLoginUser=MRCfg.savedUsers[getIndexOfUser(a[b].username)],saveMRCfg(),notify("\u9ED8\u8BA4\u8D26\u53F7\u5DF2\u8BBE\u7F6E\u4E3A\uFF1A"+a[b].username)}),$("#hoyoung_login").unbind().click(function(){let a=$table.bootstrapTable("getSelections");a.length>1?notify("\u5751\u7239\u5462\uFF0C\u4F60\u9ED8\u8BA4\u767B\u5F55\u8FD9\u4E48\u591A\u4E2A\u7528\u6237\u5417\uFF1F"):login(a[0].username,MRCfg.savedUsers[getIndexOfUser(a[0].username)].password)}),$("#hoyoung_del_user").unbind().click(function(){let b=$table.bootstrapTable("getSelections");for(let a=0;a<b.length;a++)delSavedUser(b[a].username);$table.bootstrapTable("load",MRCfg.savedUsers)})}function getWarpedSavedUsers(){return MRCfg.savedUsers.concat()}function login(username,password){setLoginUserData(username,password),moniFormSubmit("https://mis.murongtech.com/mrmis/login.do",loginUser)}function setLoginUserData(username,password){$.ajax({url:"/mrmis/common/srand_num.jsp?"+new Date().getTime(),type:"POST",async:!1,success:function(a){console.log("1234"),loginUser.oper_pwd=strEnc(password,a),loginUser.oper_no=username,loginUser.rad=a}})}function refreshTable(){let data=$("#murong-table");data.bootstrapTable("load",data.bootstrapTable("getData"))}function moniFormSubmit(url,args){$(document.body);var input,form=$("<form method='post'></form>");form.attr({action:url}),$.each(args,function(a,b){(input=$("<input type='hidden'>")).attr({name:a}),input.val(b),form.append(input)}),form.appendTo(document.body),form.submit()}function getLocation(){return location.toString()}function btnGenerator(id,text,bColor="",custom_icon="",btnHint=""){return $(`<button class='btn btn-primary ${bColor} popovers' data-trigger='hover' data-placement='top' data-content='${btnHint}' style='margin-left: 10px' id='${id}'><i class='${custom_icon}'/> ${text}</button><span style='display: inline-block;margin: 0 2rem;border-left: 2px solid #8080805e;'>1</span>`)}function welcome(){""!==MRCfg.welcomeWords&&notify(MRCfg.welcomeWords)}function mergeObject(obj1,obj2){function combine(object1,object2){for(let i in object2)void 0===object1[i]||null===object1[i]?object1[i]=object2[i]:Array.isArray(object1[i])||"object"!=typeof object1[i]||combine(object1[i],object2[i])}function del(object1,object2){for(let i in object1)void 0===object2[i]||null===object2[i]?delete object1[i]:Array.isArray(object1[i])||"object"!=typeof object1[i]||del(object1[i],object2[i])}combine(obj1,obj2),del(obj1,obj2)}function notify(msg){Messenger().post({singleton:!0,message:msg})}function isLoginPage(){return"https://mis.murongtech.com/mrmis/"==getLocation()|| -1!==getLocation().indexOf("https://mis.murongtech.com/mrmis/login.do")|| -1!==getLocation().indexOf("https://mis.murongtech.com/mrmis/logOut.do")}function isChuQingPage(){return -1!==getLocation().indexOf("https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332005")|| -1!==getLocation().indexOf("https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332015")}function dateFormat(fmt,date){let ret,opt={"Y+":date.getFullYear().toString(),"m+":(date.getMonth()+1).toString(),"d+":date.getDate().toString(),"H+":date.getHours().toString(),"M+":date.getMinutes().toString(),"S+":date.getSeconds().toString()};for(let k in opt)(ret=new RegExp("("+k+")").exec(fmt))&&(fmt=fmt.replace(ret[1],1==ret[1].length?opt[k]:opt[k].padStart(ret[1].length,"0")));return fmt}