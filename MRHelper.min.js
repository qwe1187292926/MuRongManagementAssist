// ==UserScript==
// @name         出勤助手
// @namespace    https://github.com/qwe1187292926/
// @version      0429
// @icon         https://www.agemys.com/favicon.ico
// @description  A script enhance MR attendance management
// @homepageURL    https://github.com/qwe1187292926/MuRongManagementAssist
// @supportURL     https://github.com/qwe1187292926/MuRongManagementAssist/issue
// @updateURL    https://cdn.jsdelivr.net/gh/qwe1187292926/MuRongManagementAssist/MRHelper.min.js
// @downloadURL    https://cdn.jsdelivr.net/gh/qwe1187292926/MuRongManagementAssist/MRHelper.min.js
// @author       NOBODY
// @match      https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332005
// @match      https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332015
// @match      https://mis.murongtech.com/mrmis/login.do
// @match      https://mis.murongtech.com/mrmis/
// @match      https://mis.murongtech.com/mrmis/toHome.do
// @match      https://mis.murongtech.com/mrmis/logOut.do
// @require      https://mis.murongtech.com/mrmis/js/bootstrap-datatable/bootstrap-table.js?t=202009080152320
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// ==/UserScript==
(()=>{var __webpack_exports__={};const WORK_DAY="0",ON_WORK="01",TRAVEL_DICT={1:"出差",0:"正常"},WORK_DICT={"03":"事假","04":"病假","05":"婚假","02":"调休","00":"未出勤",12:"居家办公",14:"育儿假",11:"远程","06":"丧假","07":"陪产假","08":"产假",13:"病休",10:"产检假","09":"年假","01":"√"};let loginUser={oper_no:"",oper_pwd:"",oper_log_mod:"1",rad:""},MRCfg={IamBusinessTrip:!1,resetFirstLoadRows:0,enableSavedPwd:!1,defaultLoginUser:{username:"",password:""},savedUsers:[],proId:"",welcomeWords:"智能出勤脚本加载成功！",order:""},readConfigArray=[void 0];function initMRCfg(){let e=GM_getValue("MR_CONFIG","");""==e?(GM_setValue("MR_CONFIG",MRCfg),e=MRCfg):mergeObject(e,MRCfg),MRCfg=e}function saveMRCfg(){GM_setValue("MR_CONFIG",MRCfg)}function setSavedUsers(e,t){console.log(e,t);let n={username:e,password:t};MRCfg.savedUsers.push(n),saveMRCfg()}function delSavedUser(e){MRCfg.savedUsers.splice(getIndexOfUser(e),1),saveMRCfg()}function getIndexOfUser(e){return MRCfg.savedUsers.findIndex((t=>t.username===e))}function setWorkStatus(){const e=getMRTable();e.bootstrapTable("checkAll");const t=e.bootstrapTable("getSelections");let n=t.length;for(let e=1;e<=n;e++){let n=t[e-1];n.hld_flg==WORK_DAY&&(n.att_typ=ON_WORK),MRCfg.IamBusinessTrip&&(n.travel_flg=1)}MRCfg.IamBusinessTrip&&notify("出差辛苦了~已勾选全部自然日为出差！"),refreshTable(),notify("已自动勾选工作日为出勤！")}function setProductInfo(proId,rows,isSave=!0){$HTTP("post","https://mis.murongtech.com/mrmis/attProjectQuery.do","search=&t="+Date.now()+"&limit=10&offset=0&totalRows=8&pro_nm="+proId,(function(res){res=JSON.parse(res.responseText);let data=res.rec[0];if("1"==res.rec_num||confirm("当前项目包含多个项目编号，是否选用最相近的结果：\n项目编号："+data.pro_id+"\n项目名称：《"+data.pro_nm+"》\n项目负责人："+data.att_man_nm)){console.log(res);const length=rows.length;for(let n=1;n<=length;n++){const row=rows[n-1];for(let key in data)eval("row."+key+"= data['"+key+"']")}refreshTable(),isSave&&(MRCfg.proId=proId,saveMRCfg(),notify(`${proId} 项目编号已记录`)),notify(`已应用${proId}到选中行`)}else console.log("ads",res),notify("项目查询结果包含多个或无结果！")}),(function(e){console.log(e),notify("请求失败，详见控制台！")}))}function $HTTP(e,t,n,o,a){GM_xmlhttpRequest({method:e,url:t,data:n,headers:{Referer:getLocation(),"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Cookie:document.cookie},onload:o,onerror:a})}!function(){"use strict";initMRCfg();let e=MRCfg.order,t="undefined"==typeof unsafeWindow?window:unsafeWindow;if(""!==e){let t=e.split("|"),n=t[0],o=t[1];"r"===n&&(MRCfg.order="",saveMRCfg(),window.location.href=o)}if(isLoginPage()){const e=$("#oper_no"),n=$("#oper_pwd1");""!=MRCfg.defaultLoginUser.password&&""!=MRCfg.defaultLoginUser.username&&(notify("已自动填充默认登录账号"),n.val(MRCfg.defaultLoginUser.password),e.val(MRCfg.defaultLoginUser.username)),MRCfg.savedUsers.length>1&&""==MRCfg.defaultLoginUser.password&&notify("你可以点击标题设置自动填充登录用户或者进行多账号管理！");const o=$($("button[type=submit]")[0]);$("body").append($("<input type='file' id='Hoyoung_config_file' style='display:none'>"));const a=$("#Hoyoung_config_file");a.on("change",importConfig);let i=$("<a>导出脚本配置</a>"),s=$('<a style="margin-left: 1rem">导入脚本配置</a>'),l=$('<a style="margin-left: 1rem">恢复默认配置</a>');return i.click((()=>{exportConfig(MRCfg)})),l.click((()=>{MRCfg="",saveMRCfg(),notify("已清空配置文件，将在三秒后刷新页面"),setTimeout((()=>{t.location.reload()}),3e3)})),s.click((()=>{readConfigArray[1]=$.Deferred(),a.click(),readConfigArray[1].then((()=>{let e=readConfigArray[0];MRCfg=e.MY_CONFIG,saveMRCfg(),notify("配置导入成功，3秒后将自动刷新页面"),setTimeout((()=>{t.location.reload()}),3e3)}))})),$($("a[data-toggle]")[0]).parent().parent().append(i),$($("a[data-toggle]")[0]).parent().parent().append(s),$($("a[data-toggle]")[0]).parent().parent().append(l),o.removeAttr("type"),o.text("Save and login"),o.click((e=>{e.preventDefault();const t=$("#oper_no").val(),n=$("#oper_pwd1").val();let o=MRCfg.savedUsers.find((e=>e.username===t));null!=o&&MRCfg.enableSavedPwd?n!=o.password&&setSavedUsers(t,n):MRCfg.enableSavedPwd&&setSavedUsers(t,n),login(t,n)})),void $("h3.form-title").click((function(){initTableSavedUsers()}))}welcome();const n=$("#toolbar");0!==n.length&&(n.prepend(btnGenerator("hoyoung_set_status_data"," 自选条件填充","yellow-stripe","fa fa-check-square-o","将选中行应用这个出勤状态")),n.prepend(btnGenerator("hoyoung_set_product_data"," 智慧填充","green-stripe","fa fa-rocket","将该项目编号填入到所有项目，并自动勾选出勤状态")),n.prepend('<input id="search_proid" placeholder="请输入项目编号" style="margin-right: 5px;max-width: 8rem" class="m-wrap span5" type="text" value="'+MRCfg.proId+'"/>'),n.find("#hoyoung_set_product_data").click((function(){const e=getMRTable();e.bootstrapTable("checkAll");const t=e.bootstrapTable("getSelections");setProductInfo(n.find("#search_proid").val(),t),setWorkStatus()})),n.find("#hoyoung_set_status_data").click((function(){initConditionApply()})),0!=MRCfg.resetFirstLoadRows&&isChuQingPage()&&($("table#murong-table").bootstrapTable("getOptions").pageSize=MRCfg.resetFirstLoadRows,conditionQuery()));let o='<li id="multiAccount"><a href="#"><i class="icon-user"></i>多账号管理</a></li>';$("ul.nav li.user").before(o),o='<li id="hoyoung_setting"><a href="#"><i class="icon-cogs"></i>脚本设置</a></li>',$("ul.nav li.user").before(o),$("#multiAccount").click((()=>{initTableSavedUsers()})),$("#hoyoung_setting").click((()=>{initSettingModal()}))}();let modalCurView="";function customMyModelView(e,t){if(0==$("#hoyoungModal").length){modalCurView=t;let n='<div aria-hidden="false"aria-labelledby="myModalLabel"role="dialog"tabindex="-1"id="hoyoungModal"class="modal fade ui-draggable in"style="display: block;"><div class="modal-dialog"style="width: 600px;"><div class="portlet box blue"><div class="portlet-title"><div class="caption"><i class="icon-reorder"></i><span id="closeM">'+t+'</span></div></div><div class="portlet-body modal-body"id="mmmmodal-body">'+e+"</div></div></div></div>";$("body").append(n),$("#hoyoungModal").hide(),$("#hoyoungModal").modal("show"),$("#closeM").click((()=>{hideModal()}))}else modalCurView!==t&&(modalCurView=t,$("#closeM").text(t),$("#mmmmodal-body").html(e)),$("#hoyoungModal").modal("show")}let getMRTable=()=>$("#murong-table");function initConditionApply(){let e="",t='<div>出勤情况：<select name="chk_sts" id="hoyoung_custom_status_data" class="m-wrap span5" style="margin: 0 0px 0 1rem;padding:0;max-width: 5rem">',n=Object.keys(WORK_DICT),o=Object.values(WORK_DICT);for(let e=0;e<n.length;e++)t+=`<option value=${n[e]}>${o[e]}</option>`;t+="</select></div>",t+='<div>是否出差：<select name="chk_sts" id="hoyoung_custom_travel_data" class="m-wrap span5" style="margin:0 0px 0 1rem;padding:0;max-width: 5rem">',n=Object.keys(TRAVEL_DICT),o=Object.values(TRAVEL_DICT);for(let e=0;e<n.length;e++)t+=`<option value=${n[e]}>${o[e]}</option>`;t+="</select></div>",customMyModelView('<div style="/* display:flex; *//* justify-content: flex-start; *//* align-content: center; *//* flex-wrap: nowrap; *//* flex-direction: row; */"><div class="span3"style="width: 100%;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;"><div><label class="btn green-stripe" style="margin: 0;">起始日期</label><input class="span5 m-wrap" placeholder="日期格式: YYmmdd" id="hoyoung_custom_start_date" value="'+dateFormat("YYmm",new Date)+'01" style="margin: 0 0 0 1rem;width: fit-content;"></div>—<div><label class="btn green-stripe"style="margin: 0;">结束日期</label><input class="span5 m-wrap" placeholder="日期格式: YYmmdd" value="'+dateFormat("YYmmdd",new Date)+'" id="hoyoung_custom_end_date" style="margin: 0 0 0 1rem;width: fit-content;"></div></div><div class="span3"style="width: 100%;padding-top: 1rem;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;">'+t+'</div><div class="pull-right"><label for="skipHoliday"style="width: fit-content;margin-top: 2rem;margin-left: auto;"><input type="checkbox"id="skipHoliday"style="margin: 0;">&nbsp;忽略节假日</label><label for="applyProduct" style="width: fit-content;margin-left: auto;"><input type="checkbox" id="applyProduct" style="margin: 0;"><span id="apSpan">&nbsp;另设项目编号</span></label><button class="pull-right btn yellow-stripe"style=""id="hoyoung_custom_apply">应用到所选日期区间</button></div><div class="span3"style="width: 100%;padding-top: 1rem;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;color: green;align-items: center;">*日期的填写格式为YYmmdd，即年月日，需要满足八位长度（例如2022年1月1日对应的是20220101），毋须携带横杠</div></div>',"按自选规则填充"),$("#applyProduct").unbind().click((()=>{$("#applyProduct").prop("checked")?(e=prompt("输入项目编号"),""!==e&&$("#apSpan").text(" 另设项目编号("+e+")")):$("#apSpan").text(" 另设项目编号")})),$("#hoyoung_custom_apply").unbind().click((function(){let t=-1;const n=getMRTable();n.bootstrapTable("uncheckAll");let o=n.bootstrapTable("getOptions").data;const a=$("#skipHoliday").prop("checked");let i=$("#hoyoung_custom_start_date").val(),s=$("#hoyoung_custom_end_date").val();$.each(o,(function(e,n){let o=parseInt(n.att_dt);if(o>=i&&o<=s){if(a&&n.hld_flg!==WORK_DAY)return!0;-1===t&&(t=e),n.state=!0,n.att_typ=$("#hoyoung_custom_status_data").val(),n.travel_flg=$("#hoyoung_custom_travel_data").val()}})),""!=e&&(o=n.bootstrapTable("getSelections"),notify("请稍后，正在应用项目编号，禁止操作"),setProductInfo(e,o,!1)),hideModal(),refreshTable(),console.log($("tbody tr")[t]),$("tbody tr")[t].scrollIntoView()}))}function initSettingModal(){let checkedAble=MRCfg.IamBusinessTrip?"checked":"";customMyModelView('<div style="/* display:flex; *//* justify-content: flex-start; *//* align-content: center; *//* flex-wrap: nowrap; *//* flex-direction: row; */"><div class="span3"style="width: 100%;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;"><label class="btn green-stripe"style="margin: 0;">修改默认加载数据的条数</label><input class="span5 m-wrap"name="hoyoung-setting"id="resetFirstLoadRows"value="'+MRCfg.resetFirstLoadRows+'"style="margin: 0 1rem 0 0;width: fit-content;"></div><div class="span3"style="width: 100%;display: flex;margin-left: 0;margin-top: 1rem;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;"><label class="btn blue-stripe"style="margin: 0;">脚本启动提示</label><input class="span5 m-wrap"name="hoyoung-setting"id="welcomeWords"value="'+MRCfg.welcomeWords+'"style="margin: 0 1rem 0 0;width: fit-content;"></div><div class="span3" style="width: 100%;display: flex;margin-left: 0;margin-top: 1rem;align-content: center;justify-content: space-between;flex-wrap: wrap;flex-direction: row;align-items: center;"><label class="btn blue-stripe" style="margin: 0;">出差设置</label><label for="IamBusinessTrip" style="width: fit-content;margin-left: auto;"><input type="checkbox" name="hoyoung-setting" id="IamBusinessTrip" '+checkedAble+' style="vertical-align: middle;margin: auto;">&nbsp;我在出差</label></div><button class="btn pull-right yellow-stripe"style="margin-top: 1rem;"id="hoyoung-save-setting">保存设置</button><div class="span3"style="width: 100%;padding-top: 1rem;display: flex;margin-left: 0;align-content: center;justify-content: space-between;flex-wrap: wrap;color: green;flex-direction: row;align-items: center;"><p style="margin: 0">* 数据默认加载条数，默认为10条，当该值被设置为0时，不再劫持默认加载条数。</p><p style="margin: 0">&nbsp;&nbsp;当脚本启动提示参数被设置为空时，启动完毕不再发出提醒。</p></div></div>',"出勤脚本设置"),$("#hoyoung-save-setting").unbind().click((function(){$("input[name=hoyoung-setting]").each(((i,obj)=>{let v=getValue(obj);eval("MRCfg."+$(obj).attr("id")+"="+v),saveMRCfg(),hideModal()})),console.log(MRCfg)}))}function getValue(e){return"checkbox"==$(e).attr("type")?$(e).prop("checked"):(v=$(e).val(),"NaN"===parseFloat(v).toString()&&(v="'"+v+"'"),v)}function hideModal(){$("#hoyoungModal").modal("hide")}function initTableSavedUsers(){customMyModelView('<div style="display: flex;justify-content: space-between;flex-wrap: wrap;"><button class="btn btn-primary"id="hoyoung_set_dfl_login_user"><i class="fa fa-check-square-o"></i>默认登录用户</button><button class="btn btn-primary"id="hoyoung_login"><i class="fa fa-check-square-o"></i>Login</button><button class="btn btn-primary"id="hoyoung_del_user"><i class="fa fa-check-square-o"></i>delete</button></div><table class="murong-table table table-hover"id="hoyoung_table"data-toggle="table"data-click-to-select="true"data-show-columns="false"data-select-item-name="myRadioName"></table>',"切换登录用户"),$table=$("#hoyoung_table"),$table.on("click-row.bs.table",(function(e,t,n){$(".success").removeClass("success"),$(n).addClass("success")})),$table.bootstrapTable({columns:[{fileid:"state",checkbox:!0},{title:"序号",field:"index",align:"center",valign:"middle",sortable:"true"},{title:"用户名",field:"username",align:"center",valign:"middle",sortable:"true"}]}),$table.on("click-row.bs.table",(function(e,t,n){$(".success").removeClass("success"),$(n).addClass("success")})),$table.bootstrapTable("load",getWarpedSavedUsers()),$("#hoyoung_set_dfl_login_user").unbind().click((function(){let e=$table.bootstrapTable("getSelections");if(e.length>1)notify("坑爹呢，你默认登录这么多个用户吗？");else for(let t=0;t<e.length;t++)MRCfg.defaultLoginUser=MRCfg.savedUsers[getIndexOfUser(e[t].username)],saveMRCfg(),notify("默认账号已设置为："+e[t].username)})),$("#hoyoung_login").unbind().click((function(){let e=$table.bootstrapTable("getSelections");e.length>1?notify("坑爹呢，你默认登录这么多个用户吗？"):(MRCfg.order="r|https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332005#",saveMRCfg(),login(e[0].username,MRCfg.savedUsers[getIndexOfUser(e[0].username)].password))})),$("#hoyoung_del_user").unbind().click((function(){let e=$table.bootstrapTable("getSelections");for(let t=0;t<e.length;t++)delSavedUser(e[t].username);$table.bootstrapTable("load",MRCfg.savedUsers)}))}function getWarpedSavedUsers(){return MRCfg.savedUsers.concat()}function exportConfig(e){return downFile("MRHelper_CONFIG.json",{VERSION:GM_info.script.version,MY_CONFIG:e})}function importConfig(){let e=document.getElementById("Hoyoung_config_file").files[0],t=new FileReader;function n(e="文件格式错误"){return notify(e)}t.onload=function(){try{if(readConfigArray[0]=JSON.parse(decodeURIComponent(this.result)),"object"==typeof readConfigArray[0]&&readConfigArray[0]){const e=["VERSION","MY_CONFIG"];for(const t of e)if(!readConfigArray[0].hasOwnProperty(t))return n();return readConfigArray[1].resolve()}return n()}catch(e){return n()}},t.readAsText(e)}function downFile(e,t){let n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function login(e,t){setLoginUserData(e,t),moniFormSubmit("https://mis.murongtech.com/mrmis/login.do",loginUser)}function setLoginUserData(e,t){$.ajax({url:"/mrmis/common/srand_num.jsp?"+(new Date).getTime(),type:"POST",async:!1,success:function(n){console.log("1234"),loginUser.oper_pwd=strEnc(t,n),loginUser.oper_no=e,loginUser.rad=n}})}function refreshTable(){const e=getMRTable();e.bootstrapTable("load",e.bootstrapTable("getData"))}function moniFormSubmit(e,t){$(document.body);var n,o=$("<form method='post'></form>");o.attr({action:e}),$.each(t,(function(e,t){(n=$("<input type='hidden'>")).attr({name:e}),n.val(t),o.append(n)})),o.appendTo(document.body),o.submit()}function getLocation(){return location.toString()}function btnGenerator(e,t,n="",o="",a=""){return $(`<button class='btn btn-primary ${n} popovers' data-trigger='hover' data-placement='top' data-content='${a}' style='margin-left: 10px' id='${e}'><i class='${o}'/> ${t}</button><span style='display: inline-block;margin: 0 2rem;border-left: 2px solid #8080805e;'>1</span>`)}function welcome(){""!==MRCfg.welcomeWords&&notify(MRCfg.welcomeWords)}function mergeObject(e,t){!function e(t,n){for(let o in n)void 0===t[o]||null===t[o]?t[o]=n[o]:Array.isArray(t[o])||"object"!=typeof t[o]||e(t[o],n[o])}(e,t),function e(t,n){for(let o in t)void 0===n[o]||null===n[o]?delete t[o]:Array.isArray(t[o])||"object"!=typeof t[o]||e(t[o],n[o])}(e,t)}function notify(e){Messenger().post({singleton:!0,message:e})}function isLoginPage(){return"https://mis.murongtech.com/mrmis/"==getLocation()||-1!==getLocation().indexOf("https://mis.murongtech.com/mrmis/login.do")||-1!==getLocation().indexOf("https://mis.murongtech.com/mrmis/logOut.do")}function isChuQingPage(){return-1!==getLocation().indexOf("https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332005")||-1!==getLocation().indexOf("https://mis.murongtech.com/mrmis/toMenu.do?menu_id=332015")}function dateFormat(e,t){let n;const o={"Y+":t.getFullYear().toString(),"m+":(t.getMonth()+1).toString(),"d+":t.getDate().toString(),"H+":t.getHours().toString(),"M+":t.getMinutes().toString(),"S+":t.getSeconds().toString()};for(let t in o)n=new RegExp("("+t+")").exec(e),n&&(e=e.replace(n[1],1==n[1].length?o[t]:o[t].padStart(n[1].length,"0")));return e}})();